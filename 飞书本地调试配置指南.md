# 飞书本地调试配置指南

## 1. 创建飞书应用

### 1.1 注册开发者账号
- 访问：https://open.feishu.cn/
- 使用飞书账号登录并完成开发者认证

### 1.2 创建企业自建应用
1. 进入"控制台"
2. 点击"创建应用" → "企业自建应用"
3. 填写应用信息：
   - 应用名称：审批打印插件
   - 应用描述：飞书审批记录打印插件
   - 应用图标：上传合适图标

### 1.3 配置应用权限
在应用管理中，添加以下权限：
- `bitable:app` - 多维表格应用权限
- `bitable:readonly` - 多维表格只读权限
- `bitable:write` - 多维表格写入权限

## 2. 配置本地开发环境

### 2.1 获取应用凭证
在应用详情页获取：
- App ID
- App Secret

### 2.2 安装飞书CLI工具
```bash
npm install -g @lark/cli
```

### 2.3 登录飞书开发者账号
```bash
lark login
```

## 3. 配置本地调试

### 3.1 修改webpack配置
在 `webpack.config.js` 中添加devServer配置：
```javascript
devServer: {
  port: 3002,
  host: '0.0.0.0', // 允许外部访问
  disableHostCheck: true, // 禁用host检查
  headers: {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization'
  }
}
```

### 3.2 配置环境变量
创建 `.env.local` 文件：
```env
VITE_APP_ID=your_app_id_here
VITE_APP_SECRET=your_app_secret_here
```

### 3.3 修改SDK初始化代码
在 `src/services/feishu-sdk.ts` 中添加真实的SDK初始化：
```typescript
async init() {
  try {
    // 检查是否在飞书环境
    if (window.location.href.includes('feishu.cn') ||
        window.location.href.includes('larksuite.com')) {

      // 真实飞书环境 - 使用飞书SDK
      const { bitable } = await import('@lark/base-open-platform-sdk');
      this.bitable = bitable;
      this.context = await this.bitable.base.getContext();

      console.log('飞书SDK初始化成功:', this.context);
    } else {
      // 本地开发环境 - 使用模拟数据
      console.log('本地开发环境：使用模拟数据');
      this.initMockContext();
    }
  } catch (error) {
    console.error('SDK初始化失败，使用模拟数据:', error);
    this.initMockContext();
  }
}
```

## 4. 飞书多维表格配置

### 4.1 创建多维表格
1. 在飞书中创建新的多维表格
2. 设置表格字段：
   - 审批实例ID (文本)
   - 审批类型 (单选)
   - 申请人 (文本)
   - 申请部门 (文本)
   - 审批状态 (单选)
   - 申请时间 (日期时间)
   - 审批时间 (日期时间)

### 4.2 配置机器人权限
1. 在多维表格中添加机器人
2. 选择你创建的应用
3. 授予读写权限

## 5. 启动本地调试

### 5.1 启动本地开发服务器
```bash
cd UI-Builder完整方案
npm run dev
```

### 5.2 配置飞书调试
1. 在飞书开放平台中配置重定向URL：
   - 开发环境：`http://localhost:3002`
   - 生产环境：`https://your-domain.com`

2. 启用调试模式：
   - 在应用设置中启用"调试模式"
   - 添加你的飞书账号为调试用户

## 6. 测试流程

### 6.1 创建测试数据
在多维表格中添加一些测试数据，包括各种审批状态的记录。

### 6.2 验证功能
1. 审批记录列表显示
2. 审批详情查看
3. 打印预览功能
4. 模板管理功能

## 7. 常见问题

### 7.1 跨域问题
如果遇到跨域错误，确保：
- webpack配置了正确的CORS头
- 飞书开放平台配置了正确的重定向URL

### 7.2 权限问题
如果遇到权限错误：
- 检查应用权限配置
- 确认机器人已被添加到多维表格
- 验证用户是否有访问权限

### 7.3 SDK加载失败
如果SDK无法加载：
- 检查是否在正确的飞书环境中
- 验证App ID和App Secret是否正确
- 确认网络连接正常

## 8. 部署清单

在部署前确保：
- [ ] 应用权限配置正确
- [ ] 多维表格字段匹配
- [ ] 机器人权限已授予
- [ ] 重定向URL配置正确
- [ ] 所有功能在本地测试通过

## 9. 调试技巧

### 9.1 使用浏览器开发者工具
- 查看Console输出
- 检查Network请求
- 使用Application面板查看本地存储

### 9.2 模拟真实数据
在 `src/services/feishu-sdk.ts` 中的模拟数据尽量接近真实数据格式。

### 9.3 热重载
利用webpack的热重载功能快速调试界面变化。